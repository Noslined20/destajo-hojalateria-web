<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pintura - Gesti√≥n Profesional</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <style>
    /* ===== ESTILOS BASE ===== */
    :root {
      --primary: #ef4444; /* Rojo intenso */
      --dark: #0f172a;
      --bg-body: #f8fafc;
      --text-main: #0f172a;
      --success: #16a34a;
    }

    * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; padding: 0; min-height: 100vh; background: var(--bg-body); color: var(--text-main); font-size: 16px; padding-bottom: 80px; }

    /* =========================================
       LOGIN ESTILO DARK LUXURY
       ========================================= */
    .login-shell {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999;
      display: flex; align-items: center; justify-content: center; padding: 20px;
      background: url("https://images.unsplash.com/photo-1618843479313-40f8afb4b4d8?q=80&w=1920&auto=format&fit=crop");
      background-size: cover; background-position: center; background-color: #050505;
    }
    .login-shell::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); pointer-events: none; }
    
    .login-card {
      position: relative; z-index: 10; width: 100%; max-width: 380px;
      background: #111827; border: 1px solid #1f2937; border-radius: 16px;
      padding: 40px 30px; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.8);
    }
    .login-icon-svg { width: 80px; height: 80px; margin-bottom: 15px; stroke: #ffffff; stroke-width: 1.5; fill: none; stroke-linecap: round; stroke-linejoin: round; }
    .login-title { color: #ffffff; font-size: 1.5rem; font-weight: 700; margin: 0 0 35px 0; text-transform: uppercase; letter-spacing: 2px; }
    
    .input-wrapper { margin-bottom: 20px; text-align: left; }
    .input-wrapper label { color: #9ca3af; font-size: 0.7rem; font-weight: 700; margin-left: 2px; margin-bottom: 8px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .login-input { width: 100%; padding: 14px 16px; border-radius: 8px; border: 1px solid #374151; background: #1f2937; color: #fff; font-size: 0.95rem; outline: none; transition: 0.2s; }
    .login-input:focus { border-color: #ef4444; background: #374151; }
    
    .btn-login { width: 100%; padding: 14px; border-radius: 8px; border: none; background: #ef4444; color: white; font-size: 0.9rem; font-weight: 700; margin-top: 15px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); transition: background 0.2s; }
    .btn-login:hover { background: #dc2626; }
    #loginError { color: #fca5a5; margin-top: 15px; font-weight: 600; font-size: 0.9rem; }


    /* =========================================
       APP PRINCIPAL
       ========================================= */
    .app-shell { max-width: 1000px; margin: 0 auto; padding: 15px; display: none; }

    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: relative; padding: 10px 0; border-bottom: 1px solid #e2e8f0; }
    .app-logo { position: absolute; left: 50%; transform: translateX(-50%); font-size: 1.4rem; font-weight: 800; color: #1e293b; text-transform: uppercase; letter-spacing: 2px; }
    .btn-logout { background: white; border: 1px solid #cbd5e1; padding: 8px 12px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; color: #64748b; margin-left: auto; text-transform: uppercase; cursor: pointer; }

    /* DASHBOARD FINANCIERO */
    .stats-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    @media (max-width: 600px) { .stats-row { grid-template-columns: 1fr; } }

    .stat-card { background: white; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .stat-label { font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; display: block; margin-bottom: 5px; }
    .stat-val { font-size: 1.4rem; font-weight: 800; color: var(--dark); }
    
    .stat-card.dark { background: #1e293b; color: white; border: none; }
    .stat-card.dark .stat-label { color: #94a3b8; }
    .stat-card.dark .stat-val { color: #fff; }

    .input-ghost {
      background: transparent;
      border: none;
      border-bottom: 2px dashed #94a3b8;
      width: 90px;
      font-weight: 800;
      font-size: 1.3rem;
      text-align: center;
      color: #ffffff !important; 
      outline: none;
    }
    .input-ghost::placeholder { color: rgba(255,255,255,0.3); }
    .input-ghost:focus { border-bottom-color: var(--primary); }

    /* FORMULARIO */
    .main-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #e2e8f0; }
    .form-row { display: flex; gap: 12px; margin-bottom: 15px; }
    .col-half { flex: 1; }
    .col-full { width: 100%; margin-bottom: 15px; }
    @media (max-width: 500px) { .form-row { flex-direction: column; gap: 10px; } }

    label { display: block; font-size: 0.7rem; font-weight: 800; color: #64748b; margin-bottom: 6px; margin-left: 4px; text-transform: uppercase; }
    
    input.app-input, textarea, select { 
      width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 16px; background: #f8fafc; outline: none; appearance: none; color: #1e293b; font-weight: 500; 
    }
    input.app-input:focus, textarea:focus, select:focus { border-color: var(--primary); background: #fff; }

    /* CONCEPTOS */
    .concept-item { display: grid; grid-template-columns: 2fr 1fr 1fr 30px; gap: 5px; margin-bottom: 8px; align-items: center; background: #f1f5f9; padding: 8px; border-radius: 8px; border: 1px solid #e2e8f0; }
    @media (max-width: 500px) { .concept-item { grid-template-columns: 1fr 1fr; row-gap: 8px; } .concept-item select { grid-column: span 2; } }
    
    .btn-add { width: 100%; padding: 10px; border: 2px dashed #cbd5e1; background: white; color: #64748b; font-weight: 700; border-radius: 8px; margin-bottom: 15px; cursor: pointer; text-transform: uppercase; font-size: 0.8rem; }
    .btn-x { background: #fee2e2; color: #ef4444; border: none; height: 30px; width: 30px; border-radius: 6px; font-weight: bold; cursor: pointer; }

    .btn-save { width: 100%; background: var(--primary); color: white; border: none; padding: 14px; border-radius: 8px; font-size: 1rem; font-weight: 800; display: flex; justify-content: center; gap: 8px; text-transform: uppercase; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2); cursor: pointer; }

    /* HERRAMIENTAS */
    .tools-section { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
    .btn-group { display: flex; gap: 8px; margin-top: 10px; }
    .btn-tool { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; background: #f8fafc; color: #475569; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; cursor: pointer; }

    /* ===== LISTA M√ìVIL (TARJETAS) ===== */
    .mobile-list { display: flex; flex-direction: column; gap: 15px; }
    .m-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; }
    
    .m-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: white; }
    .m-info h3 { margin: 0; font-size: 1.1rem; font-weight: 800; color: var(--dark); }
    .m-info p { margin: 2px 0 0; font-size: 0.8rem; color: #64748b; }
    .m-badge { display: inline-block; background: #eff6ff; color: #3b82f6; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; border: 1px solid #dbeafe; margin-top: 4px;}
    
    .m-money { text-align: right; }
    .m-total { font-size: 1.1rem; font-weight: 800; color: var(--success); display: block; }
    .m-arrow { font-size: 0.8rem; color: #cbd5e1; margin-top: 5px; display: block;}

    .m-body { display: none; padding: 15px; background: #f8fafc; border-top: 1px solid #f1f5f9; }
    .m-body.open { display: block; }
    .m-detail-row { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 5px; color: #475569; border-bottom: 1px dashed #e2e8f0; padding-bottom: 5px; }
    .m-actions { display: flex; gap: 10px; margin-top: 15px; }
    .btn-act { flex: 1; padding: 10px; border-radius: 8px; border: none; font-weight: 700; font-size: 0.9rem; cursor: pointer; }

    /* TABLA ESCRITORIO */
    .desktop-table-container { display: none; width: 100%; overflow-x: auto; background: white; border-radius: 12px; border: 1px solid #e2e8f0; }
    table { width: 100%; border-collapse: collapse; min-width: 800px; }
    th { text-align: left; padding: 15px; background: #f8fafc; color: #64748b; font-size: 0.7rem; text-transform: uppercase; font-weight: 800; }
    td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; vertical-align: top; }

    @media (min-width: 769px) {
      .desktop-table-container { display: block; }
      .mobile-list { display: none; }
    }
  </style>
</head>
<body>

  <div id="loginWrapper" class="login-shell">
    <div class="login-card">
      <svg class="login-icon-svg" viewBox="0 0 100 100">
        <path d="M20 50 L30 35 L70 35 L80 50" stroke="white" stroke-width="3" fill="none"/>
        <path d="M20 50 L20 70 L80 70 L80 50" stroke="white" stroke-width="3" fill="none"/>
        <rect x="25" y="55" width="10" height="8" stroke="white" stroke-width="2" fill="none"/>
        <rect x="65" y="55" width="10" height="8" stroke="white" stroke-width="2" fill="none"/>
        <line x1="40" y1="55" x2="60" y2="55" stroke="white" stroke-width="2"/>
        <line x1="40" y1="60" x2="60" y2="60" stroke="white" stroke-width="2"/>
        <line x1="40" y1="65" x2="60" y2="65" stroke="white" stroke-width="2"/>
        <path d="M75 25 L75 15 L95 15 L95 25 Z" stroke="white" stroke-width="3" fill="none"/> <path d="M85 25 L85 40" stroke="white" stroke-width="3"/> <path d="M70 40 L100 40 L100 50 L90 50 L90 70 L80 70 L80 50 L70 50 Z" stroke="white" stroke-width="3" fill="none"/> <path d="M70 40 L60 30" stroke="white" stroke-width="2"/> <path d="M65 45 L55 45" stroke="white" stroke-width="2"/> 
      </svg>
      <h1 class="login-title">PINTURA</h1>
      <div class="input-wrapper"><label>Correo</label><input type="email" id="loginEmail" class="login-input" /></div>
      <div class="input-wrapper"><label>Contrase√±a</label><input type="password" id="loginPassword" class="login-input" /></div>
      <button id="btnLogin" class="btn-login">ENTRAR</button>
      <div id="loginError"></div>
    </div>
  </div>

  <div id="appWrapper" class="app-shell">
    
    <div class="top-bar">
      <div class="app-logo">PINTURA</div>
      <button id="btnLogout" class="btn-logout">SALIR</button>
    </div>

    <div class="stats-row">
      <div class="stat-card">
        <span class="stat-label">Ganado</span>
        <div class="stat-val" style="color:var(--primary)" id="dispComisiones">$0</div>
      </div>
      <div class="stat-card dark" id="cardNeta">
        <span class="stat-label">Ganancia Neta</span>
        <div class="stat-val" id="dispNeta">$0</div>
      </div>
      <div class="stat-card dark" style="background:#334155;">
        <span class="stat-label">Material Semanal</span>
        <div>
          $ <input type="number" id="inputMaterial" class="input-ghost" placeholder="0">
          <span id="btnSaveMat" style="cursor:pointer; font-size:1.7rem;" title="Guardar">üíæ</span>
        </div>
      </div>
    </div>

    <div class="main-card">
      <div class="form-row">
        <div class="col-half"><label>AUTO *</label><input type="text" id="inputAuto" class="app-input" placeholder="Ej. MUSTANG" /></div>
        <div class="col-half"><label>COLOR *</label><input type="text" id="inputColor" class="app-input" placeholder="Ej. PLATA" /></div>
      </div>

      <div class="form-row">
        <div class="col-half"><label>ORDEN *</label><input type="tel" id="inputOrden" class="app-input" placeholder="12345" /></div>
        <div class="col-half"><label>PLACA</label><input type="text" id="inputPlaca" class="app-input" placeholder="ABC-123" autocapitalize="characters" /></div>
      </div>

      <label>Conceptos de Cobro</label>
      <div id="containerConceptos"></div>
      <button id="btnAgregarConcepto" class="btn-add">+ Agregar Concepto</button>

      <div class="col-full">
        <label>OBSERVACI√ìN</label>
        <textarea id="inputObservacion" rows="2" placeholder="Notas..."></textarea>
      </div>

      <button id="btnGuardar" class="btn-save">üíæ GUARDAR</button>
      <button id="btnLimpiar" style="width:100%; padding:12px; margin-top:10px; background:none; border:none; color:#94a3b8; font-size:0.75rem; font-weight:700; text-transform:uppercase; cursor:pointer;">Limpiar Campos</button>
    </div>

    <div class="tools-section">
      <input type="text" id="inputBuscar" class="app-input" placeholder="üîç Buscar orden..." style="font-weight:600; margin-bottom:10px;" />
      
      <div class="form-row">
        <div class="col-half"><input type="date" id="dateDesde" class="app-input" /></div>
        <div class="col-half"><input type="date" id="dateHasta" class="app-input" /></div>
      </div>

      <div class="btn-group">
        <button id="btnLimpiarFiltros" class="btn-tool">‚ùå Filtro</button>
        <button id="btnCSV" class="btn-tool">üìä CSV</button>
        <button id="btnPDFSimple" class="btn-tool" style="background:#e0f2fe; color:#0369a1; border-color:#bae6fd;">üìÑ Ordenes</button>
        <button id="btnPDF" class="btn-tool" style="background:#fef2f2; color:#b91c1c; border-color:#fecaca;">üìÑ Total</button>
      </div>
      <div id="textoPeriodo" style="text-align:center; font-size:0.75rem; color:#94a3b8; margin-top:10px;">...</div>
    </div>

    <div class="mobile-list" id="mobileContainer"></div>

    <div class="desktop-table-container">
      <table id="tablaRegistros">
        <thead>
          <tr>
            <th>Auto / Color</th>
            <th>Orden</th>
            <th>Finanzas</th>
            <th>Fecha</th>
            <th style="text-align:right">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbodyRegistros"></tbody>
      </table>
    </div>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, updateDoc, deleteDoc, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCFzS_kJPxulB7JMkL6C0lwncUcf5YJ2sc",
      authDomain: "destajo-hojalateria.firebaseapp.com",
      projectId: "destajo-hojalateria",
      storageBucket: "destajo-hojalateria.firebasestorage.app",
      messagingSenderId: "313174097212",
      appId: "1:313174097212:web:73f75a346000acd96db239"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const colRef = collection(db, "registros");
    const docConfig = doc(db, "configuracion", "gastos_semanales");

    // ESTADO
    let allDocs = [];
    let viewDocs = [];
    let editId = null;
    let materialCost = 0;
    let conceptosForm = [];

    const el = (id) => document.getElementById(id);
    const formatMoney = (n) => "$" + n.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    const formatLatino = (iso) => { 
        if(!iso) return ""; 
        const parts = iso.split("-"); 
        if(parts.length < 3) return iso;
        return `${parts[2]}/${parts[1]}/${parts[0]}`; 
    };

    // RENDERIZADO DUAL
    function render(lista) {
      viewDocs = lista;
      const tb = el("tbodyRegistros");
      const mob = el("mobileContainer");
      tb.innerHTML = "";
      mob.innerHTML = "";

      let totalComisiones = 0;

      if(!lista.length) {
        mob.innerHTML = `<div style="text-align:center; padding:20px; color:#94a3b8;">No hay registros</div>`;
        return;
      }

      lista.forEach(r => {
        let totalOrden = 0;
        let htmlDesglose = "";
        let arrayDesglose = [];

        if(r.conceptos && r.conceptos.length > 0) {
          r.conceptos.forEach(c => {
            const m = parseFloat(c.monto)||0;
            const p = parseFloat(c.porcentaje)||0;
            const g = m * (p/100);
            totalOrden += g;
            htmlDesglose += `<div style="font-size:0.8rem; color:#64748b">${c.nombre}: <b>$${g.toFixed(0)}</b></div>`;
            arrayDesglose.push({nombre: c.nombre, val: g});
          });
        } else {
          htmlDesglose = "<span style='color:#cbd5e1; font-size:0.8rem;'>--</span>";
        }
        totalComisiones += totalOrden;

        const obs = r.observacion || r.detalle || "";

        // 1. ESCRITORIO
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><b>${r.auto}</b><br><span style="font-size:0.8rem; color:#64748b">${r.color}</span></td>
          <td><span style="background:#eff6ff; color:#3b82f6; padding:3px 6px; border-radius:4px; font-weight:bold; font-size:0.8rem;">${r.orden}</span></td>
          <td>${htmlDesglose}<div style="border-top:1px solid #e2e8f0; font-weight:bold; color:var(--success); margin-top:2px;">Total: $${totalOrden.toFixed(0)}</div></td>
          <td style="font-size:0.85rem;">${formatLatino(r.fecha)}</td>
          <td style="text-align:right;">
             <button onclick="window.edit('${r.id}')" style="cursor:pointer; border:none; background:none; font-size:1.2rem;">‚úèÔ∏è</button>
             <button onclick="window.del('${r.id}')" style="cursor:pointer; border:none; background:none; color:#ef4444; font-size:1.2rem;">üóëÔ∏è</button>
          </td>
        `;
        tb.appendChild(tr);

        // 2. M√ìVIL
        let htmlDetalleMovil = "";
        if(arrayDesglose.length > 0) {
            arrayDesglose.forEach(item => {
                htmlDetalleMovil += `
                <div class="m-detail-row">
                    <span>${item.nombre}</span>
                    <b>$${item.val.toFixed(0)}</b>
                </div>`;
            });
        } else { htmlDetalleMovil = "<span style='color:#cbd5e1'>Sin conceptos</span>"; }

        const card = document.createElement("div");
        card.className = "m-card";
        card.innerHTML = `
          <div class="m-header" onclick="this.nextElementSibling.classList.toggle('open')">
            <div class="m-info">
              <h3>${r.auto}</h3>
              <p>${r.color} ‚Ä¢ ${formatLatino(r.fecha)}</p>
              <span class="m-badge">#${r.orden}</span>
            </div>
            <div class="m-money">
              <span class="m-total">$${totalOrden.toFixed(0)}</span>
              <span class="m-arrow">‚ñº Ver</span>
            </div>
          </div>
          <div class="m-body">
            <div style="margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid #e2e8f0;">
               ${htmlDetalleMovil}
            </div>
            ${obs ? `<div style="font-style:italic; font-size:0.8rem; color:#64748b; background:#fff; padding:8px; border:1px solid #e2e8f0; border-radius:6px; margin-bottom:10px;">üìù ${obs}</div>` : ''}
            <div class="m-actions">
              <button class="btn-act" style="background:#e0f2fe; color:#0369a1" onclick="window.edit('${r.id}')">Editar</button>
              <button class="btn-act" style="background:#fee2e2; color:#b91c1c" onclick="window.del('${r.id}')">Borrar</button>
            </div>
          </div>
        `;
        mob.appendChild(card);
      });

      // Actualizar Dashboard
      if(el("dispComisiones")) el("dispComisiones").textContent = formatMoney(totalComisiones);
      const neta = totalComisiones - materialCost;
      if(el("dispNeta")) el("dispNeta").textContent = formatMoney(neta);
      if(el("cardNeta")) el("cardNeta").style.background = neta < 0 ? "#7f1d1d" : "#0f172a";
    }

    // CONCEPTOS FORM
    function renderConceptInputs() {
      const c = el("containerConceptos"); c.innerHTML = "";
      conceptosForm.forEach((item, i) => {
        const div = document.createElement("div");
        div.className = "concept-item";
        
        div.innerHTML = `
          <select class="app-input" style="margin:0" onchange="window.updCon(${i},'nombre',this.value)">
            <option value="Aseguradora" ${item.nombre==='Aseguradora'?'selected':''}>Aseguradora</option>
            <option value="Reacondicionado" ${item.nombre==='Reacondicionado'?'selected':''}>Reacondicionado</option>
            <option value="Rin" ${item.nombre==='Rin'?'selected':''}>Rin</option>
            <option value="Particular" ${item.nombre==='Particular'?'selected':''}>Particular</option>
            <option value="Otro" ${item.nombre==='Otro'?'selected':''}>Otro</option>
          </select>
          <input type="number" class="app-input" style="margin:0" placeholder="$" value="${item.monto}" oninput="window.updCon(${i},'monto',this.value)">
          <input type="number" class="app-input" style="margin:0" placeholder="%" value="${item.porcentaje}" oninput="window.updCon(${i},'porcentaje',this.value)">
          ${i>0 ? `<button class="btn-x" onclick="window.delCon(${i})">√ó</button>` : '<span></span>'}
        `;
        c.appendChild(div);
      });
    }

    window.updCon = (i,k,v) => { conceptosForm[i][k] = v; };
    window.delCon = (i) => { conceptosForm.splice(i,1); renderConceptInputs(); };
    el("btnAgregarConcepto").onclick = () => { conceptosForm.push({nombre:"Aseguradora",monto:"",porcentaje:""}); renderConceptInputs(); };

    // FILTROS
    function filtrar() {
      const q = el("inputBuscar").value.trim().toUpperCase();
      const d1 = el("dateDesde").value;
      const d2 = el("dateHasta").value;
      
      let lista = [...allDocs];
      let txt = "Mostrando todo";

      const getViernes = () => {
         const d = new Date(); d.setHours(0,0,0,0);
         const day = d.getDay();
         const sub = (day >= 5) ? (day - 5) : (day + 2);
         d.setDate(d.getDate() - sub);
         const off = d.getTimezoneOffset()*60000;
         return new Date(d.getTime()-off).toISOString().slice(0,10);
      };

      if(q) {
         lista = lista.filter(r => String(r.orden).includes(q) || r.auto.includes(q));
         txt = `Busqueda: ${q}`;
      } else if (d1 || d2) {
         if(d1) lista = lista.filter(r => r.fecha >= d1);
         if(d2) lista = lista.filter(r => r.fecha <= d2);
         txt = `Del ${formatLatino(d1)} al ${formatLatino(d2)}`;
      } else {
         const vier = getViernes();
         lista = lista.filter(r => r.fecha >= vier);
         txt = `Semana actual (Desde ${formatLatino(vier)})`;
      }
      
      if(el("textoPeriodo")) el("textoPeriodo").innerText = txt;
      render(lista);
    }

    // OPERACIONES
    el("btnGuardar").onclick = async () => {
      const auto = el("inputAuto").value.trim().toUpperCase();
      const orden = el("inputOrden").value.trim();
      if(!auto || !orden) return alert("Falta Auto u Orden");

      const conceptos = conceptosForm.filter(c => c.monto && c.porcentaje);
      const data = {
        auto, color: el("inputColor").value.toUpperCase(), orden,
        placa: el("inputPlaca").value.toUpperCase(),
        observacion: el("inputObservacion").value,
        conceptos,
        fecha: new Date().toISOString().slice(0,10)
      };

      try {
        if(editId) await updateDoc(doc(db, "registros", editId), data);
        else await addDoc(colRef, { ...data, createdAt: serverTimestamp() });
        limpiar();
      } catch(e) { alert(e.message); }
    };

    if(el("btnSaveMat")){
        el("btnSaveMat").onclick = async () => {
           const v = parseFloat(el("inputMaterial").value)||0;
           await setDoc(docConfig, { totalMaterial: v }, { merge: true });
           alert("Costo Material Guardado");
        };
    }

    function limpiar() {
      el("inputAuto").value=""; el("inputColor").value=""; el("inputOrden").value=""; el("inputPlaca").value=""; el("inputObservacion").value="";
      editId = null; el("btnGuardar").textContent = "üíæ GUARDAR"; el("btnGuardar").style.background = "var(--primary)";
      conceptosForm = [{nombre:"Aseguradora",monto:"",porcentaje:""}]; renderConceptInputs();
      window.scrollTo({top:0, behavior:'smooth'});
    }

    window.edit = (id) => {
      const r = allDocs.find(x => x.id === id);
      el("inputAuto").value=r.auto; el("inputColor").value=r.color; el("inputOrden").value=r.orden; 
      el("inputPlaca").value=r.placa||""; el("inputObservacion").value=r.observacion||r.detalle||"";
      conceptosForm = (r.conceptos && r.conceptos.length) ? [...r.conceptos] : [{nombre:"Aseguradora",monto:"",porcentaje:""}];
      renderConceptInputs();
      editId = id; el("btnGuardar").textContent = "ACTUALIZAR"; el("btnGuardar").style.background = "#eab308";
      window.scrollTo({top:0, behavior:'smooth'});
    };

    window.del = async (id) => { if(confirm("¬øEliminar?")) await deleteDoc(doc(db,"registros",id)); };
    el("btnLimpiar").onclick = limpiar;

    el("btnCSV").onclick = () => {
       const rows = viewDocs.map(r => [r.auto, r.color, r.orden, r.placa, (r.observacion||r.detalle||"").replace(/\n/g," ")]);
       const csv = "AUTO,COLOR,ORDEN,PLACA,OBS\n" + rows.map(r => r.join(",")).join("\n");
       const a = document.createElement("a");
       a.href = URL.createObjectURL(new Blob([csv],{type:"text/csv"})); a.download = "data.csv"; a.click();
    };

    // ============================================
    //    PDF SIMPLE (SOLO ORDENES - SIN DINERO)
    // ============================================
    el("btnPDFSimple").onclick = () => {
      if(!viewDocs.length) return alert("No hay datos para generar el reporte.");
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      const colorPrimary = [239, 68, 68]; // Rojo
      const colorDark = [15, 23, 42];     // Azul oscuro
      const colorGray = [100, 116, 139];
      
      // ENCABEZADO
      doc.setFont("helvetica", "bold");
      doc.setFontSize(18);
      doc.setTextColor(...colorDark);
      doc.text("LISTADO DE ORDENES", 14, 20); // Titulo diferente
      
      doc.setFontSize(10);
      doc.setFont("helvetica", "normal");
      doc.setTextColor(...colorGray);
      
      doc.setFontSize(11);
      doc.setTextColor(0, 0, 0);
      doc.text(el("textoPeriodo").innerText, 14, 34);

      // CUERPO DE LA TABLA (SIN DINERO)
      const tableBody = viewDocs.map(r => [
          r.orden,
          r.auto,
          r.color,
          r.placa || "-",
          (r.observacion || r.detalle || "")
      ]);

      doc.autoTable({
        startY: 40,
        head: [["ORDEN", "AUTO", "COLOR", "PLACA", "NOTAS"]],
        body: tableBody,
        theme: 'grid',
        headStyles: { 
            fillColor: colorPrimary, 
            textColor: 255, 
            fontStyle: 'bold',
            halign: 'center'
        },
        columnStyles: {
            0: { halign: 'center', fontStyle: 'bold', cellWidth: 25 },
            3: { halign: 'center' }
        },
        styles: { fontSize: 10, cellPadding: 3, valign: 'middle' },
      });

      doc.save("Ordenes_Taller_" + new Date().toISOString().slice(0,10) + ".pdf");
    };

    // ============================================
    //    PDF FINANCIERO (CON DINERO Y TOTALES)
    // ============================================
    el("btnPDF").onclick = () => {
      if(!viewDocs.length) return alert("No hay datos para generar el reporte.");
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      const colorPrimary = [239, 68, 68];
      const colorDark = [15, 23, 42];
      const colorGray = [100, 116, 139];
      
      doc.setFont("helvetica", "bold");
      doc.setFontSize(18);
      doc.setTextColor(...colorDark);
      doc.text("REPORTE FINANCIERO", 14, 20);
      
      doc.setFontSize(10);
      doc.setFont("helvetica", "normal");
      doc.setTextColor(...colorGray);
      
      doc.setFontSize(11);
      doc.setTextColor(0, 0, 0);
      doc.text(el("textoPeriodo").innerText, 14, 34);

      let sumaTotalGanado = 0;

      const tableBody = viewDocs.map(r => {
        let totalOrden = 0;
        let detalleTexto = "";
        
        if(r.conceptos && r.conceptos.length) {
            r.conceptos.forEach(c => {
                const m = parseFloat(c.monto)||0;
                const p = parseFloat(c.porcentaje)||0;
                const ganancia = m * (p/100);
                totalOrden += ganancia;
                detalleTexto += `‚Ä¢ ${c.nombre}: $${ganancia.toFixed(0)}\n`;
            });
        } else {
            detalleTexto = "Sin conceptos";
        }
        
        sumaTotalGanado += totalOrden;

        return [
          r.orden,
          r.auto + "\n" + r.color,
          detalleTexto,
          (r.observacion || ""),
          "$" + totalOrden.toFixed(0)
        ];
      });

      doc.autoTable({
        startY: 40,
        head: [["ORDEN", "VEH√çCULO", "CONCEPTOS", "NOTAS", "TOTAL"]],
        body: tableBody,
        theme: 'grid',
        headStyles: { 
            fillColor: colorPrimary, 
            textColor: 255, 
            fontStyle: 'bold',
            halign: 'center'
        },
        columnStyles: {
            0: { halign: 'center', fontStyle: 'bold', cellWidth: 20 },
            4: { halign: 'right', fontStyle: 'bold', textColor: [22, 163, 74] }
        },
        styles: { fontSize: 9, cellPadding: 3, valign: 'middle' },
      });

      let finalY = doc.lastAutoTable.finalY + 10;
      if (finalY > 250) { doc.addPage(); finalY = 20; }

      const gastoMaterial = parseFloat(el("inputMaterial").value) || 0;
      const utilidadNeta = sumaTotalGanado - gastoMaterial;

      doc.setFillColor(248, 250, 252);
      doc.setDrawColor(203, 213, 225);
      doc.rect(120, finalY, 75, 35, 'FD');

      doc.setFontSize(10);
      doc.setTextColor(...colorGray);
      doc.text("RESUMEN DEL PERIODO", 125, finalY + 8);

      doc.setFontSize(11);
      doc.setTextColor(0,0,0);
      doc.text("Total Ganado:", 125, finalY + 16);
      doc.setFont("helvetica", "bold");
      doc.text("$" + sumaTotalGanado.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ","), 190, finalY + 16, { align: "right" });

      doc.setFont("helvetica", "normal");
      doc.text("(-) Material:", 125, finalY + 23);
      doc.setTextColor(220, 38, 38);
      doc.text("-$" + gastoMaterial.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ","), 190, finalY + 23, { align: "right" });

      doc.setDrawColor(200, 200, 200);
      doc.line(125, finalY + 26, 190, finalY + 26);
      
      doc.setFont("helvetica", "bold");
      doc.setFontSize(13);
      doc.setTextColor(...colorDark);
      doc.text("UTILIDAD NETA:", 125, finalY + 32);
      
      if(utilidadNeta >= 0) doc.setTextColor(22, 163, 74); 
      else doc.setTextColor(220, 38, 38);

      doc.text("$" + utilidadNeta.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ","), 190, finalY + 32, { align: "right" });

      doc.save("Reporte_Finanzas_" + new Date().toISOString().slice(0,10) + ".pdf");
    };

    // AUTH
    el("inputBuscar").oninput = filtrar; el("dateDesde").onchange = filtrar; el("dateHasta").onchange = filtrar;
    el("btnLimpiarFiltros").onclick = () => { el("dateDesde").value=""; el("dateHasta").value=""; el("inputBuscar").value=""; filtrar(); };

    el("btnLogin").onclick = async () => {
      try { await signInWithEmailAndPassword(auth, el("loginEmail").value, el("loginPassword").value); }
      catch(e) { el("loginError").innerText = "Error credenciales"; }
    };
    el("btnLogout").onclick = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
      if(user) {
        el("loginWrapper").style.display = "none"; el("appWrapper").style.display = "block";
        onSnapshot(docConfig, (s) => { 
            if(s.exists() && el("inputMaterial")) { 
                materialCost = s.data().totalMaterial||0; 
                el("inputMaterial").value = materialCost; 
                filtrar(); 
            } 
        });
        onSnapshot(query(colRef, orderBy("createdAt","asc")), (s) => {
          allDocs = s.docs.map(d => {
             let f = d.data().fecha; if(!f && d.data().createdAt) f = d.data().createdAt.toDate().toISOString().slice(0,10);
             return {id:d.id, ...d.data(), fecha:f||""};
          });
          filtrar();
        });
        limpiar();
      } else { el("loginWrapper").style.display = "flex"; el("appWrapper").style.display = "none"; }
    });
  </script>
</body>
</html>
