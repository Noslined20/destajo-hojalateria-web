<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control Pintura</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <style>
    /* ===== ESTILOS BASE ===== */
    :root {
      --primary: #ef4444; /* Rojo intenso */
      --bg-body: #f8fafc;
      --text-main: #0f172a;
    }

    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: var(--bg-body);
      color: var(--text-main);
      font-size: 16px;
    }

    /* ===== LOGIN ESTILO DARK LUXURY (PORSCHE) ===== */
    .login-shell {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      /* FONDO: Porsche negro en estudio oscuro */
     background: url("https://images.unsplash.com/photo-1618843479313-40f8afb4b4d8?q=80&w=1920&auto=format&fit=crop");
      background-size: cover;
      background-position: center;
      background-color: #050505;
    }

    /* Capa oscura sutil sobre la imagen para resaltar el login */
    .login-shell::before {
      content: "";
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.4); 
      pointer-events: none;
    }

    .login-card {
      position: relative;
      z-index: 10;
      width: 100%;
      max-width: 380px;
      /* Fondo azul muy oscuro / casi negro como la imagen */
      background: #111827; 
      border: 1px solid #1f2937;
      border-radius: 16px;
      padding: 40px 30px;
      text-align: center;
      box-shadow: 0 25px 50px rgba(0,0,0,0.8);
    }

    /* ICONO SVG PERSONALIZADO (Auto + Pistola) */
    .login-icon-svg {
      width: 80px;
      height: 80px;
      margin-bottom: 15px;
      stroke: #ffffff;
      stroke-width: 1.5;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .login-title {
      color: #ffffff;
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0 0 35px 0;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .input-wrapper {
      margin-bottom: 20px;
      text-align: left;
    }

    .input-wrapper label {
      color: #9ca3af; /* Gris azulado */
      font-size: 0.7rem;
      font-weight: 700;
      margin-left: 2px;
      margin-bottom: 8px;
      display: block;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .login-input {
      width: 100%;
      padding: 14px 16px;
      border-radius: 8px;
      border: 1px solid #374151; /* Borde sutil */
      background: #1f2937; /* Fondo input oscuro */
      color: #fff;
      font-size: 0.95rem;
      outline: none;
      transition: 0.2s;
    }
    
    .login-input:focus {
      border-color: #ef4444; /* Rojo al seleccionar */
      background: #374151;
    }

    .btn-login {
      width: 100%;
      padding: 14px;
      border-radius: 8px;
      border: none;
      background: #ef4444; /* Rojo deportivo */
      color: white;
      font-size: 0.9rem;
      font-weight: 700;
      margin-top: 15px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
      transition: background 0.2s;
    }
    .btn-login:hover { background: #dc2626; }

    /* ===== APP (ESTILOS ORIGINALES) ===== */
    .app-shell {
      max-width: 900px;
      margin: 0 auto;
      padding: 15px;
      display: none; 
      padding-bottom: 80px; 
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      position: relative;
      padding: 10px 0;
      border-bottom: 1px solid #e2e8f0;
    }
    .app-logo { 
      position: absolute; 
      left: 50%; 
      transform: translateX(-50%);
      font-size: 1.4rem; 
      font-weight: 800; 
      color: #1e293b; 
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .btn-logout { 
      background: white; 
      border: 1px solid #cbd5e1; 
      padding: 8px 12px; 
      border-radius: 6px; 
      font-size: 0.7rem; 
      font-weight: 700; 
      color: #64748b;
      margin-left: auto;
      text-transform: uppercase;
    }

    /* STATS */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    .stat-box {
      background: white;
      padding: 15px 5px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid #e2e8f0;
    }
    .stat-num { font-size: 1.5rem; font-weight: 800; color: #0f172a; line-height: 1; }
    .stat-txt { font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: 700; margin-top:5px; }

    /* FORMULARIO */
    .main-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
      margin-bottom: 25px;
      border: 1px solid #e2e8f0;
    }

    .form-row { display: flex; gap: 12px; margin-bottom: 15px; }
    .col-half { flex: 1; }
    .col-full { width: 100%; margin-bottom: 15px; }

    label {
      display: block;
      font-size: 0.7rem;
      font-weight: 800;
      color: #64748b;
      margin-bottom: 6px;
      margin-left: 4px;
      text-transform: uppercase;
    }

    input, textarea {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      font-size: 16px; 
      background: #f8fafc;
      outline: none;
      appearance: none;
      color: #1e293b;
      font-weight: 500;
    }
    input:focus, textarea:focus { border-color: var(--primary); background: #fff; }

    .btn-save {
      width: 100%;
      background: var(--primary);
      color: white;
      border: none;
      padding: 14px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 800;
      display: flex;
      justify-content: center;
      gap: 8px;
      text-transform: uppercase;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
    }

    /* HERRAMIENTAS */
    .tools-section {
      background: #fff;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid #e2e8f0;
    }
    
    .search-row { margin-bottom: 12px; }
    .date-row { display: flex; gap: 10px; align-items: center; margin-bottom: 12px; }
    .date-input { flex: 1; padding: 10px; font-size: 0.85rem; background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 8px;}

    .export-row { display: flex; gap: 8px; }
    .btn-tool {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      color: #475569;
      font-size: 0.75rem;
      font-weight: 800;
      text-transform: uppercase;
    }

    /* TABLA */
    .table-wrapper {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #e2e8f0;
      overflow-x: auto;
    }
    table { width: 100%; border-collapse: collapse; min-width: 700px; }
    
    th, td {
      text-align: center;
      vertical-align: middle;
      padding: 14px 10px;
      border-bottom: 1px solid #f1f5f9;
      font-size: 0.85rem;
    }
    thead { background: #f1f5f9; }
    th { color: #64748b; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; font-weight:800; }
    
    .cell-detalle {
      max-width: 150px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-style: italic;
      color: #64748b;
    }

    tbody tr:first-child { background-color: #fef2f2; }
    tbody tr:first-child td { font-weight: 600; color: var(--primary); }
    tbody tr:first-child .cell-detalle { font-weight: 400; color: #ef4444; }

    .placa-tag { background: #f1f5f9; padding: 4px 8px; border-radius: 4px; font-family: monospace; border: 1px solid #e2e8f0; font-size: 0.8rem; font-weight: 700; color: #334155; }
    .btn-act { background: none; border: none; font-size: 1.2rem; padding: 5px; cursor: pointer; }
    
    #loginError { color: #fca5a5; margin-top: 15px; font-weight: 600; font-size: 0.9rem; }

  </style>
</head>
<body>

  <div id="loginWrapper" class="login-shell">
    <div class="login-card">
      
    
        <path d="M20 50 L30 35 L70 35 L80 50" stroke="white" stroke-width="3" fill="none"/>
        <path d="M20 50 L20 70 L80 70 L80 50" stroke="white" stroke-width="3" fill="none"/>
        <rect x="25" y="55" width="10" height="8" stroke="white" stroke-width="2" fill="none"/>
        <rect x="65" y="55" width="10" height="8" stroke="white" stroke-width="2" fill="none"/>
        <line x1="40" y1="55" x2="60" y2="55" stroke="white" stroke-width="2"/>
        <line x1="40" y1="60" x2="60" y2="60" stroke="white" stroke-width="2"/>
        <line x1="40" y1="65" x2="60" y2="65" stroke="white" stroke-width="2"/>
        
        <path d="M75 25 L75 15 L95 15 L95 25 Z" stroke="white" stroke-width="3" fill="none"/> <path d="M85 25 L85 40" stroke="white" stroke-width="3"/> <path d="M70 40 L100 40 L100 50 L90 50 L90 70 L80 70 L80 50 L70 50 Z" stroke="white" stroke-width="3" fill="none"/> <path d="M70 40 L60 30" stroke="white" stroke-width="2"/> <path d="M65 45 L55 45" stroke="white" stroke-width="2"/> </svg>

      <h1 class="login-title">PINTURA</h1>
      
      <div class="input-wrapper">
        <label>Correo</label>
        <input type="email" id="loginEmail" class="login-input" />
      </div>
      
      <div class="input-wrapper">
        <label>Contrase√±a</label>
        <input type="password" id="loginPassword" class="login-input" />
      </div>

      <button id="btnLogin" class="btn-login">ENTRAR</button>
      <div id="loginError"></div>
    </div>
  </div>

  <div id="appWrapper" class="app-shell">
    
    <div class="top-bar">
      <div class="app-logo">PINTURA</div>
      <button id="btnLogout" class="btn-logout">Salir</button>
    </div>

    <div class="stats-grid">
      <div class="stat-box">
        <div class="stat-num" id="statTotal">0</div>
        <div class="stat-txt">Total</div>
      </div>
      <div class="stat-box">
        <div class="stat-num" id="statUltimo">‚Äî</div>
        <div class="stat-txt">√öltimo</div>
      </div>
      <div class="stat-box" style="background:#fff1f2; border-color:#fecaca;">
        <div class="stat-num" id="statSemana" style="color:var(--primary); font-size:0.7rem; line-height:2; font-weight:700;">...</div>
        <div class="stat-txt" style="color:var(--primary);">Vista</div>
      </div>
    </div>

    <div class="main-card">
      <div class="form-row">
        <div class="col-half">
          <label>AUTO *</label>
          <input type="text" id="inputAuto" placeholder="Ej. MUSTANG" />
        </div>
        <div class="col-half">
          <label>COLOR *</label>
          <input type="text" id="inputColor" placeholder="Ej. PLATA" />
        </div>
      </div>

      <div class="form-row">
        <div class="col-half">
          <label>ORDEN *</label>
          <input type="tel" id="inputOrden" placeholder="12345" />
        </div>
        <div class="col-half">
          <label>PLACA</label>
          <input type="text" id="inputPlaca" placeholder="ABC-123" autocapitalize="characters" />
        </div>
      </div>

      <div class="col-full">
        <label>DETALLE DEL TRABAJO</label>
        <textarea id="inputDetalle" rows="2" placeholder="Piezas a pintar, reparaciones..."></textarea>
      </div>

      <button id="btnGuardar" class="btn-save">üíæ GUARDAR</button>
      <button id="btnLimpiar" style="width:100%; padding:12px; margin-top:10px; background:none; border:none; color:#94a3b8; font-size:0.75rem; font-weight:700; text-transform:uppercase;">Limpiar Campos</button>
    </div>

    <div class="tools-section">
      <div class="search-row">
        <input type="number" id="inputBuscar" placeholder="üîç Buscar orden hist√≥rica..." style="background:#f8fafc; font-weight:600;" />
      </div>

      <div class="date-row">
        <input type="date" id="dateDesde" class="date-input" />
        <span style="color:#64748b; font-size:0.7rem; font-weight:800;">AL</span>
        <input type="date" id="dateHasta" class="date-input" />
      </div>

      <div class="export-row">
        <button id="btnLimpiarFiltros" class="btn-tool">‚ùå Filtro</button>
        <button id="btnCSV" class="btn-tool">üìä CSV</button>
        <button id="btnPDF" class="btn-tool">üìÑ PDF</button>
      </div>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th width="30">#</th>
            <th>AUTO</th>
            <th>COLOR</th>
            <th>ORDEN</th>
            <th>PLACA</th>
            <th>DETALLE</th> <th>FECHA</th>
            <th width="60"></th>
          </tr>
        </thead>
        <tbody id="tbodyRegistros"></tbody>
      </table>
    </div>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, updateDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCFzS_kJPxulB7JMkL6C0lwncUcf5YJ2sc",
      authDomain: "destajo-hojalateria.firebaseapp.com",
      projectId: "destajo-hojalateria",
      storageBucket: "destajo-hojalateria.firebasestorage.app",
      messagingSenderId: "313174097212",
      appId: "1:313174097212:web:73f75a346000acd96db239"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const colRef = collection(db, "registros");

    let allDocs = [];
    let viewDocs = []; 
    let editId = null;

    const el = (id) => document.getElementById(id);
    
    const getHoy = () => {
      const d = new Date();
      const off = d.getTimezoneOffset() * 60000;
      return new Date(d.getTime() - off).toISOString().slice(0,10);
    };

    const getViernesInicio = () => {
      const d = new Date();
      d.setHours(0,0,0,0);
      const day = d.getDay(); 
      const sub = (day >= 5) ? (day - 5) : (day + 2);
      d.setDate(d.getDate() - sub);
      const off = d.getTimezoneOffset() * 60000;
      return new Date(d.getTime() - off).toISOString().slice(0,10);
    };

    function render(lista) {
      viewDocs = lista; 
      const tb = el("tbodyRegistros");
      tb.innerHTML = "";
      el("statTotal").textContent = lista.length;
      el("statUltimo").textContent = lista.length ? lista[0].orden : "‚Äî";

      if(!lista.length) {
        tb.innerHTML = `<tr><td colspan="8" style="padding:30px; color:#94a3b8; font-weight:600;">Sin registros</td></tr>`;
        return;
      }

      lista.forEach((r, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="color:#94a3b8;">${i+1}</td>
          <td style="font-weight:700;">${r.auto}</td>
          <td>${r.color}</td>
          <td style="font-weight:800; color:var(--primary);">${r.orden}</td>
          <td>${r.placa ? `<span class="placa-tag">${r.placa}</span>` : '‚Äî'}</td>
          <td class="cell-detalle" title="${r.detalle}">${r.detalle || '-'}</td>
          <td style="font-size:0.8rem; font-weight:600;">${r.fecha.slice(5)}</td>
          <td>
            <div style="display:flex; justify-content:center; gap:8px;">
              <button class="btn-act" onclick="window.edit('${r.id}')">‚úèÔ∏è</button>
              <button class="btn-act" onclick="window.del('${r.id}')" style="color:var(--primary);">üóëÔ∏è</button>
            </div>
          </td>
        `;
        tb.appendChild(tr);
      });
    }

    function filtrar() {
      const term = el("inputBuscar").value.trim();
      const desde = el("dateDesde").value;
      const hasta = el("dateHasta").value;
      const inicioSemana = getViernesInicio();

      let data = [...allDocs];
      let modo = "Semanal";

      if (term) {
        data = data.filter(r => String(r.orden).includes(term));
        modo = "B√∫squeda";
      } else if (desde || hasta) {
        if(desde) data = data.filter(r => r.fecha >= desde);
        if(hasta) data = data.filter(r => r.fecha <= hasta);
        modo = "Fechas";
      } else {
        data = data.filter(r => r.fecha >= inicioSemana);
        modo = "Viernes " + inicioSemana.slice(8);
      }

      el("statSemana").textContent = modo;
      render(data);
    }

    el("btnGuardar").onclick = async () => {
      const auto = el("inputAuto").value.trim().toUpperCase();
      const color = el("inputColor").value.trim().toUpperCase();
      const orden = el("inputOrden").value.trim();
      
      if(!auto || !orden) return alert("Falta Auto u Orden");

      const datos = {
        auto, color, orden,
        placa: el("inputPlaca").value.trim().toUpperCase(),
        detalle: el("inputDetalle").value.trim(),
        fecha: getHoy()
      };

      try {
        if(editId) {
          await updateDoc(doc(db, "registros", editId), datos);
          alert("Registro actualizado");
        } else {
          await addDoc(colRef, { ...datos, createdAt: serverTimestamp() });
        }
        limpiar();
      } catch(e) { alert(e.message); }
    };

    function limpiar() {
      el("inputAuto").value=""; el("inputColor").value="";
      el("inputOrden").value=""; el("inputPlaca").value="";
      el("inputDetalle").value="";
      editId = null;
      el("btnGuardar").textContent = "üíæ GUARDAR";
      el("btnGuardar").style.background = "var(--primary)";
      window.scrollTo(0,0);
    }
    
    window.edit = (id) => {
      const r = allDocs.find(x => x.id === id);
      el("inputAuto").value=r.auto; el("inputColor").value=r.color;
      el("inputOrden").value=r.orden; el("inputPlaca").value=r.placa;
      el("inputDetalle").value=r.detalle;
      editId = id;
      el("btnGuardar").textContent = "ACTUALIZAR";
      el("btnGuardar").style.background = "#f59e0b";
      window.scrollTo(0,0);
    };

    window.del = async (id) => {
      if(confirm("¬øEliminar registro?")) await deleteDoc(doc(db, "registros", id));
    };

    el("btnLimpiar").onclick = limpiar;
    el("inputBuscar").addEventListener("input", filtrar);
    el("dateDesde").addEventListener("change", filtrar);
    el("dateHasta").addEventListener("change", filtrar);
    
    el("btnLimpiarFiltros").onclick = () => {
      el("dateDesde").value = "";
      el("dateHasta").value = "";
      el("inputBuscar").value = "";
      filtrar();
    };

    // CSV
    el("btnCSV").onclick = () => {
      if(!viewDocs.length) return alert("Sin datos");
      const headers = ["AUTO","COLOR","ORDEN","PLACA","DETALLE","FECHA"];
      const rows = viewDocs.map(r => [
        r.auto, r.color, r.orden, r.placa, (r.detalle||"").replace(/\n/g," "), r.fecha
      ]);
      let csv = headers.join(",") + "\n" + rows.map(r => r.map(c => `"${c || ''}"`).join(",")).join("\n");
      const link = document.createElement("a");
      link.href = URL.createObjectURL(new Blob([csv], {type: "text/csv;charset=utf-8;"}));
      link.download = "registros_pintura.csv";
      link.click();
    };

    // PDF
    el("btnPDF").onclick = () => {
       if(!viewDocs.length) return alert("Sin datos");
       const { jsPDF } = window.jspdf;
       const doc = new jsPDF();
       
       doc.setFontSize(16);
       doc.text("Pintura", 105, 20, null, null, "center");
       
       const fechas = viewDocs.map(r => r.fecha).sort();
       const rango = fechas.length > 1 
         ? `Del ${fechas[0]} al ${fechas[fechas.length-1]}` 
         : `Fecha: ${fechas[0] || getHoy()}`;
       
       doc.setFontSize(10);
       doc.text(rango, 105, 28, null, null, "center");

       const body = viewDocs.map(r => [r.auto, r.color, r.orden, r.placa, r.detalle, r.fecha]);
       
       doc.autoTable({ 
         head:[["AUTO","COLOR","ORDEN","PLACA","DETALLE","FECHA"]], 
         body: body, 
         startY: 35,
         headStyles: { fillColor: [239, 68, 68] },
         columnStyles: { 4: { cellWidth: 50 } } 
       });
       doc.save("reporte_pintura.pdf");
    };

    el("btnLogout").onclick = () => signOut(auth);
    el("btnLogin").onclick = async () => {
      try { await signInWithEmailAndPassword(auth, el("loginEmail").value, el("loginPassword").value); }
      catch(e) { el("loginError").textContent = "Credenciales incorrectas"; }
    };

    onAuthStateChanged(auth, (user) => {
      if(user) {
        el("loginWrapper").style.display = "none";
        el("appWrapper").style.display = "block";
        onSnapshot(query(colRef, orderBy("createdAt", "desc")), (snap) => {
          allDocs = snap.docs.map(d => {
             let f = d.data().fecha;
             if(!f && d.data().createdAt) f = d.data().createdAt.toDate().toISOString().slice(0,10);
             return {id: d.id, ...d.data(), fecha: f||""};
          });
          filtrar();
        });
      } else {
        el("loginWrapper").style.display = "flex";
        el("appWrapper").style.display = "none";
      }
    });
  </script>
</body>
</html>
